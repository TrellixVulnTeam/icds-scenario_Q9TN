<!doctype html>
<html lang='en'>
	<head>
	    <title>Seroprevalence in Nigeria</title>
        <meta name='viewport' content='width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no'>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
        <style>
			html, body {
				height: 100%;
			}
			body {
				/*background-color: #2c7fb8;*/
				background-color: black;
				color: #2e2e2e;
				margin: 0;
			}
			p {
				line-height: 2rem;
				font-family: 'Newsreader', serif;
				font-weight: 300;
				/*font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;*/
				font-size: 1.4rem;
			}
			#header-hero {
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100%;
			}
			header {
				text-align: center;
			}
			header h1 {
				/*color: #2c7fb8;*/
				color: #f4f4f2;
				font-family: 'Alfa Slab One';
			}
			header h2 {
				/*color: #f8f980;*/
				color: white;
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
				font-variant: small-caps;
				font-size: 2rem;
				font-weight: 300;
			}
			h1 {
				font-family: 'Alfa Slab One';
				font-size: 4.5rem;
				text-align: center;
			}
			#scrolly-overlay .scrolly {
				/*max-width: 60rem;*/
				/*margin: 3rem auto;*/
				background-color: #f4f4f4;
				/*padding: 1rem;*/
			}
			#scrolly-overlay .scrolly article {
				padding: 0;
				margin: 0 auto;
				position: relative;
			}
			#scrolly-overlay .scrolly article .step {
				min-height: 100vh;
				margin-bottom: 1rem;
			}
			#scrolly-overlay .scrolly article .step:last-of-type {
				margin-bottom: 0;
			}
			#scrolly-overlay .scrolly article .step-box {
				background-color: #f4f4f2;
				padding: 3rem;
			}
			#scrolly-overlay .scrolly figure.sticky {
				position: -webkit-sticky;
				position: sticky;
				width: 100%;
				height: 50vh;
				background: #969696;
				margin: 0;
				top: 25vh;
				left: 0;
			}
			.tick, .tooltip {
				font-family: 'Newsreader', serif;
			}
			.tick {
				font-size: 0.8rem;
			}
			.tooltip {
				font-size: 1.2rem;
			}
        </style>
		<link rel="preconnect" href="https://fonts.gstatic.com">
		<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,300;0,500;1,300;1,500&display=swap" rel="stylesheet"> 
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://unpkg.com/enter-view@1.0.0/enter-view.min.js"></script>
		<script src="https://unpkg.com/stickyfilljs@2.0.5/dist/stickyfill.js"></script>
		<link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet">
		<script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
	</head>
	<body>

		<div id="header-hero">
			<header>
				<h1>Seroprevalence in Nigeria</h1>
				<h2>Data Visualization by Dave McLaughlin</h2>
			</header>
		</div>
		
		<section id="scrolly-overlay">
		
			<div class="scrolly">
				<!--  sticky graphic   -->
				<figure class="sticky step" data-index='1000' style="height: 100vh; top: 0;">
					<video id="lagos-drone" playsinline muted loop style="object-fit: cover; height: 100vh; width: 100%;">
						<source src="lagos-drone.mp4" type="video/mp4">
					</video>
				</figure>

				<!--  step text   -->
				<article style="max-width: 67vw;">
					<div class='step' data-index='0'>
						<h1 style="color: #f8f980; font-size: 6rem;">Background</h1>
						<div class="step-box" style="display: flex; flex-direction: row;">
							<div style="width: 67%; padding-right: 6rem;">
								<p>Less than a year into a pandemic, scientists are learning more about the disease in Nigeria. Testing individuals for the presence of antibodies builds a picture of the spread of the disease in the country.</p>
								<p>Using test results data, which includes the age and location of the individuals tested, can help inform public policy decisions to more accurately target vaccination campaign rollouts.</p>
								<hr style="border-top: 1px;">
								<p><small><strong>se·​ro·​prev·​a·​lence</strong> <em>/ˌsir-ō-ˈpre-və-lən(t)s</em>: the frequency of individuals in a population that have a particular element (such as antibodies to HIV) in their blood serum</small></p>
							</div>
							<div style="width: 33%;">
								<p><img src="../pcr-test.jpg" style="width: 100%;"></p>
							</div>
						</div>
					</div>
				</article>
					
			</div>

			<div class="scrolly">
				<figure class="sticky" style="height: 50vh; top: 0; background-color: #f4f4f2;">
				</figure>

				<article style="max-width: 67vw;">
					<div class='step' data-index='1'>
						<h1>Seroprevalence by Age</h1>

						<div class="step-box" style="display: flex; flex-direction: row;">
							<div style="width: 60%;">
								<div id="seroByAgeChart"></div>
								<script>
									var seroByAgeChartLoaded = 0;
								</script>
							</div>
							<div style="width: 40%;">
								<p>We&rsquo;ve found that seroprevalence varies widely within the population by age.</p>
								<p>Individuals in their late 30&rsquo;s have rates approaching 90%, while &lt;30% of those age 25&ndash;27 have antibodies.</p>
							</div>
						</div>
					</div>
					<div class='step' data-index='2' style="min-height: 67vh;">
						<div class="step-box" style="text-align: center;">
							<p>To date, <strong>31,425 individuals</strong> have been tested for antibodies in <strong>3,343 locations</strong>.</p>
						</div>
					</div>
				</article>
			</div>

			<div class="scrolly">
				
				<figure class="sticky" style="height: 100vh; top: 0;">
					<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
					<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css">
					<!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
					<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
					<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
					<div id="map" style="position: absolute; width: 100%; top: 0; bottom: 0;"></div>
					
					<script>
						mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2ZW1jbGF1Z2hsaW4iLCJhIjoiY2p4bzBlaGJ5MDF3NzNscXA5MnJyeW4xcyJ9.RlsTLBiHzI-gxBHMKZvWCg';
						var map = new mapboxgl.Map({
							container: 'map',
							style: 'mapbox://styles/mapbox/light-v10',
							center: [8, 9],
							zoom: 6
						});
					
						var coordinatesGeocoder = function (query) {
							// match anything which looks like a decimal degrees coordinate pair
							var matches = query.match(
								/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i
							);
							if (!matches) {
								return null;
							}
							
							function coordinateFeature(lng, lat) {
								return {
									center: [lng, lat],
									geometry: {
										type: 'Point',
										coordinates: [lng, lat]
									},
									place_name: 'Lat: ' + lat + ' Lng: ' + lng,
									place_type: ['coordinate'],
									properties: {},
									type: 'Feature'
								};
							}
							
							var coord1 = Number(matches[1]);
							var coord2 = Number(matches[2]);
							var geocodes = [];
							
							if (coord1 < -90 || coord1 > 90) {
								// must be lng, lat
								geocodes.push(coordinateFeature(coord1, coord2));
							}
							
							if (coord2 < -90 || coord2 > 90) {
								// must be lat, lng
								geocodes.push(coordinateFeature(coord2, coord1));
							}
							
							if (geocodes.length === 0) {
								// else could be either lng, lat or lat, lng
								geocodes.push(coordinateFeature(coord1, coord2));
								geocodes.push(coordinateFeature(coord2, coord1));
							}
							
							return geocodes;
						};
					
						map.addControl(
							new MapboxGeocoder({
								accessToken: mapboxgl.accessToken,
								localGeocoder: coordinatesGeocoder,
								countries: 'ng',
								mapboxgl: mapboxgl
							})
						);
						map.addControl(new mapboxgl.NavigationControl());
					
						map.on('load', function () {
							// Find the index of the first symbol layer in the map style
							// so that the labels can be added over the point clusters
							var layers = map.getStyle().layers;
							var firstSymbolId;
							for (var i = 0; i < layers.length; i++) {
								if (layers[i].type === 'symbol') {
									firstSymbolId = layers[i].id;
									break;
								}
							}
					
							map.addSource('clustersData', {
								type: 'geojson',
								data: 'clustersData.geojson',
								cluster: true,
								clusterMaxZoom: 22, // Max zoom to cluster points on
								clusterRadius: 1, // Radius of each cluster when clustering points (defaults to 50)
								clusterProperties: {
									sumSero: ["+", ["number", ["get", "sero"], 0]]
								}
							});
					
							map.addLayer(
								{
									id: 'clusters',
									type: 'circle',
									source: 'clustersData',
									filter: ['has', 'point_count'],
									paint: {
										'circle-radius': ['interpolate', ['linear'], ['get', 'point_count'],
											2, 6,
											100, 50
										],
										'circle-color': ['interpolate', ['linear'], ['/', ['get', 'sumSero'], ['get', 'point_count']],
											0, '#2c7fb8',
											1, '#f8f980'
										],
										'circle-opacity': ['interpolate', ['linear'], ['/', ['get', 'sumSero'], ['get', 'point_count']],
											0, 0.1,
											1, 0.8
										]
									}
								},
								firstSymbolId
							);
					
							map.addLayer({
								id: 'unclustered-point',
								type: 'circle',
								source: 'clustersData',
								filter: ['!', ['has', 'point_count']],
								paint: {
									'circle-radius': 3,
									'circle-color': ['interpolate', ['linear'], ['/', ['get', 'sero', ['properties']], 1],
										0, '#2c7fb8',
										1, '#f8f980'
									],
									'circle-opacity': ['interpolate', ['linear'], ['/', ['get', 'sero', ['properties']], 1],
										0, 0.1,
										1, 0.8
									]
								}
							});
					
							map.on('click', 'clusters', function (e) {
								var features = map.queryRenderedFeatures(e.point, {
									layers: ['clusters']
								});
								var clusterId = features[0].properties.cluster_id;
					
								new mapboxgl.Popup()
									.setLngLat(features[0].geometry.coordinates)
									.setHTML(
										'<strong>' + features[0].properties.point_count + ' Individuals</strong><br>' +
										'Seroprevalence: ' + (features[0].properties.sumSero / features[0].properties.point_count).toLocaleString("en", {style: "percent"})
									)
									.addTo(map);
							});
					
							map.on('click', 'unclustered-point', function (e) {
								var coordinates = e.features[0].geometry.coordinates.slice();
								var age = e.features[0].properties.age;
								var sero;
								if (e.features[0].properties.sero == 1) {
									sero = 'Yes';
								} else {
									sero = 'No';
								}
					
								new mapboxgl.Popup()
									.setLngLat(coordinates)
									.setHTML(
										'<strong>Single Individual</strong><br>' +
										'Age: ' + age + '<br>' +
										'Seroprevalence: ' + sero
									)
									.addTo(map);
							});
					
							map.on('mouseenter', 'clusters', function () {
								map.getCanvas().style.cursor = 'pointer';
							});
							map.on('mouseenter', 'unclustered-point', function () {
								map.getCanvas().style.cursor = 'pointer';
							});
							map.on('mouseleave', 'clusters', function () {
								map.getCanvas().style.cursor = '';
							});
							map.on('mouseleave', 'unclustered-point', function () {
								map.getCanvas().style.cursor = '';
							});

							map.scrollZoom.disable();
						});
					</script>
									</figure>


				<!--  step text   -->
				<article style="width: 90vw;">
					<div class='step' data-index='3'>
						<h1>Cluster Locations</h1>
					</div>
				</article>
				<article style="max-width: 25vw; margin: 0 auto 0 0;">
					<div class='step step-box' data-index='4'>
						<p>To date, 31,425 individuals have been tested for antibodies at 3,343 cluster locations.</p>
					</div>
					<div class='step step-box' data-index='5'>
						<p>test</p>
					</div>
				</article>
				
			</div>
		
		</section>
		
		<section style="height: 1000px;">
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
			<p>Text at the end</p>
		</section>

		<script>
			const container = d3.select('#scrolly-overlay');
			const stepSel = container.selectAll('.step');

			function init() {
				Stickyfill.add(d3.select('.sticky').node());

				enterView({
					selector: stepSel.nodes(),
					offset: 0.5,
					enter: el => {
						const index = +d3.select(el).attr('data-index');

						if (index == 1000) {
							document.getElementById("lagos-drone").play();
						}

						if (index == 1) {
							document.getElementById("lagos-drone").pause();

							if (seroByAgeChartLoaded == 0) {
								// set the dimensions and margins of the graph
								var margin = {top: 10, right: 10, bottom: 30, left: 40},
									width = 500 - margin.left - margin.right,
									height = 400 - margin.top - margin.bottom;
								// append the svg object to the body of the page
								var svg = d3.select("#seroByAgeChart")
								.append("svg")
									.attr("width", width + margin.left + margin.right)
									.attr("height", height + margin.top + margin.bottom)
								.append("g")
									.attr("transform",
										"translate(" + margin.left + "," + margin.top + ")");


								//Read the data
								d3.csv("summarySeroStats.csv",

								// Now I can use this dataset:
								function(data) {
									// Add X axis
									var x =  d3.scaleLinear()
										.domain( [40, 24])
										.range([ width, 0 ]);
									svg.append("g")
										.attr("transform", "translate(0," + height + ")")
										.attr("opacity", 0)
										.transition(500)
											.delay(250)
											.attr("opacity", 1)
										.call(d3.axisBottom(x));
									// Add Y axis
									var y = d3.scaleLinear()
										.domain( [ 0, 1 ])
										.range([ height, 0 ]);
									svg.append("g")
										.attr("opacity", 0)
										.transition(500)
											.delay(250)
											.attr("opacity", 1)
										.call(d3.axisLeft(y).tickFormat(d3.format(".0%")));

									function length(path) {
										return d3.create("svg:path").attr("d", path).node().getTotalLength();
									}
									line = d3.line()
										.x(function(d) { return x(d.age) })
										.y(function(d) { return y(d.rate) })
									const l = length(line(data));

									// create a tooltip
									var Tooltip = d3.select("#seroByAgeChart")
										.append("div")
										.style("display", "none")
										.attr("class", "tooltip")
										.style("padding", "5px")
									
									// Three function that change the tooltip when user hover / move / leave a cell
									var mouseover = function(d) {
										Tooltip
										.style("display", "block")
									}
									var mousemove = function(d) {
										Tooltip
										.html("<strong>Age " + d.age + "</strong><br>" + "Seroprevalence: " + d3.format(".0%")(d.rate))
										.style("position", "relative")
										.style("left", "300px")
										.style("top", "-150px")
									}
									var mouseleave = function(d) {
										Tooltip
										.style("display", "none")
									}

									// Add the points
									svg
										.append("g")
										.selectAll("dot")
										.data(data)
										.enter()
										.append("circle")
											.attr("cx", function(d) { return x(d.age) } )
											.attr("cy", function(d) { return y(d.rate) } )
											.attr("r", 6)
											.attr("fill", "#2c7fb8")
											.attr("opacity", 0)
											.on("mouseover", mouseover)
											.on("mousemove", mousemove)
											.on("mouseleave", mouseleave)
											.transition()
												.delay(500)
												.duration(500)
												.attr("opacity", 1)

									// Add the line
									svg.append("path")
										.datum(data)
										.attr("fill", "none")
										.attr("stroke", "#2c7fb8")
										.attr("stroke-width", 2.5)
										.attr("stroke-dasharray", `0,${l}`)
										.attr("d", line)
										.transition()
											.delay(1000)
											.duration(3000)
											.ease(d3.easeLinear)
											.attr("stroke-dasharray", `${l},${l}`);

								})
								seroByAgeChartLoaded = 1;
							}
						}

						if (index == 4) {
							map.flyTo({
								center: [ 6.8, 9 ],
								speed: 0.1,
								essential: true
							});
						}

						if (index == 5) {
							map.flyTo({
								center: [ 3.41080, 6.42857 ],
								zoom: 10.96,
								pitch: 60,
								bearing: -74.4,
								speed: 0.3,
								essential: true
							});
						}

						if (index == 7) {
							map.setStyle('mapbox://styles/mapbox/dark-v10');
						}

					},
					exit: el => {
						let index = +d3.select(el).attr('data-index');

						if (index == 1) {
							document.getElementById("lagos-drone").play();
						}

						index = Math.max(0, index - 1);

						if (index == 4) {
							map.flyTo({
								center: [ 6.8, 9 ],
								pitch: 0,
								bearing: 0,
								speed: 0.1,
								essential: true
							});
						}

					}
				});
			}

			init();
		</script>
	</body>
</html>